// src/firebase/habitsService.js - COMPLETO E CORRIGIDO: 40 PONTOS + B√îNUS INCLU√çDO
import { 
    collection, 
    doc, 
    getDocs, 
    getDoc,
    setDoc, 
    updateDoc,
    deleteDoc,
    orderBy, 
    query,
    where
  } from 'firebase/firestore';
  import { db } from './config';
  
  // üîÑ MUDAN√áA PRINCIPAL: NOVAS COLLECTIONS PARA DADOS DI√ÅRIOS
  const DAILY_HABITS = 'daily_habits';           
  const WEEKLY_AGGREGATES = 'weekly_aggregates'; 
  
  // üÜï CONFIGURA√á√ïES DOS H√ÅBITOS (suas regras) - CORRIGIDAS
  const habitMaxValues = {
    meditar: 7,    
    medicar: 3,    
    exercitar: 7,  
    comunicar: 5,  
    alimentar: 6,  // üîß REDUZIDO de 7 para 6
    estudar: 6,    // üîß REDUZIDO de 7 para 6
    descansar: 6   // üîß REDUZIDO de 7 para 6
  };
  
  // üìÖ FUN√á√ïES UTILIT√ÅRIAS DE DATA - CORRIGIDAS
  const getWeekStart = (dateISO) => {
    // ‚úÖ CORRE√á√ÉO: Usar diretamente strings para evitar problemas de timezone
    const [year, month, day] = dateISO.split('-').map(Number);
    
    // Criar data UTC para evitar problemas de timezone
    const date = new Date(Date.UTC(year, month - 1, day));
    const dayOfWeek = date.getUTCDay(); // 0=domingo, 1=segunda, ..., 6=s√°bado
    
    // ‚úÖ NOVO C√ÅLCULO: domingo = 0 dias atr√°s, segunda = 1 dia atr√°s, etc.
    const diff = -dayOfWeek; // domingo=0, segunda=-1, ter√ßa=-2, etc.
    
    // Calcular domingo da semana
    const sunday = new Date(Date.UTC(year, month - 1, day + diff));
    const sundayISO = sunday.toISOString().split('T')[0]; // YYYY-MM-DD do domingo
    
    return sundayISO;
  };
  
  const formatDateDisplay = (dateISO) => {
    const [year, month, day] = dateISO.split('-');
    return `${day}/${month}`; // DD/MM
  };
  
  const addDays = (dateISO, days) => {
    const date = new Date(dateISO);
    date.setDate(date.getDate() + days);
    return date.toISOString().split('T')[0];
  };
  
  const getDayName = (dateISO) => {
    const date = new Date(dateISO);
    const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    return days[date.getDay()];
  };
  
  // üÜï FUN√á√ÉO PRINCIPAL: SALVAR DIA + RECALCULAR SEMANA AUTOMATICAMENTE
  export const saveDailyHabits = async (dateISO, habitData) => {
    try {
      // Preparar documento di√°rio
      const dailyDoc = {
        date: dateISO,                           
        dateFormatted: formatDateDisplay(dateISO), 
        weekStart: getWeekStart(dateISO),                    // ‚úÖ Agora ser√° domingo
        dayOfWeek: getDayName(dateISO),         
        
        // Dados dos h√°bitos (boolean)
        peso: habitData.peso || null,
        meditar: habitData.meditar || false,
        medicar: habitData.medicar || false,
        exercitar: habitData.exercitar || false,
        comunicar: habitData.comunicar || false,
        alimentar: habitData.alimentar || false,
        estudar: habitData.estudar || false,
        descansar: habitData.descansar || false,
        obs: habitData.obs || '',
        sentimento: habitData.sentimento || '', // üÜï Incluir campo sentimento
        
        // Metadados
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
  
      // Salvar documento di√°rio
      await setDoc(doc(db, DAILY_HABITS, dateISO), dailyDoc);
  
      // üîÑ NOVO: Recalcular semana automaticamente ap√≥s salvar dia
      await recalculateWeek(getWeekStart(dateISO));
  
      return {
        success: true,
        data: dailyDoc
      };
  
    } catch (error) {
      return {
        success: false,
        error: error.message || 'Erro ao salvar dia'
      };
    }
  };
  
  // üÜï FUN√á√ÉO: RECALCULAR AGREGA√á√ÉO SEMANAL (SUAS REGRAS)
  const recalculateWeek = async (weekStartISO) => {
    try {
      // Buscar todos os 7 dias da semana (domingo a s√°bado)
      const weekDays = await getWeekDays(weekStartISO);
  
      if (weekDays.length === 0) {
        return;
      }
  
      // Calcular agrega√ß√µes usando suas regras
      const weekData = await calculateWeeklyAggregate(weekDays, weekStartISO);
      
      // Salvar semana agregada
      await setDoc(doc(db, WEEKLY_AGGREGATES, weekStartISO), weekData);
  
    } catch (error) {
    }
  };
  
  // üÜï FUN√á√ÉO: BUSCAR DIAS DE UMA SEMANA (domingo a s√°bado)
  const getWeekDays = async (weekStartISO) => {
    try {
      const days = [];
      
      // ‚úÖ CORRIGIDO: Buscar 7 dias consecutivos (domingo a s√°bado)
      for (let i = 0; i < 7; i++) {
        const dayISO = addDays(weekStartISO, i);
        const dayDoc = await getDoc(doc(db, DAILY_HABITS, dayISO));
        
        if (dayDoc.exists()) {
          days.push({ id: dayDoc.id, ...dayDoc.data() });
        } else {
          // üîÑ MUDAN√áA: Dia sem dados = todos os h√°bitos false (sua regra)
          days.push({
            date: dayISO,
            dateFormatted: formatDateDisplay(dayISO),
            peso: null,
            meditar: false,
            medicar: false,
            exercitar: false,
            comunicar: false,
            alimentar: false,
            estudar: false,
            descansar: false,
            obs: ''
          });
        }
      }
      
      return days;
    } catch (error) {
      return [];
    }
  };
  
  // üÜï FUN√á√ÉO: CALCULAR AGREGA√á√ÉO SEMANAL COM SUAS REGRAS ESPEC√çFICAS
  const calculateWeeklyAggregate = async (days, weekStartISO) => {
    // 1. PESO: M√©dia dos dias com peso registrado
    const daysWithPeso = days.filter(d => d.peso && d.peso > 0);
    const pesoMedio = daysWithPeso.length > 0 ? 
      daysWithPeso.reduce((sum, d) => sum + d.peso, 0) / daysWithPeso.length : 
      null;
    
    // 2. H√ÅBITOS: Soma dos dias true, limitado pelo m√°ximo semanal
    const habitCounts = {
      meditar: Math.min(days.filter(d => d.meditar).length, habitMaxValues.meditar),     
      medicar: Math.min(days.filter(d => d.medicar).length, habitMaxValues.medicar),     
      exercitar: Math.min(days.filter(d => d.exercitar).length, habitMaxValues.exercitar), 
      comunicar: Math.min(days.filter(d => d.comunicar).length, habitMaxValues.comunicar), 
      alimentar: Math.min(days.filter(d => d.alimentar).length, habitMaxValues.alimentar), 
      estudar: Math.min(days.filter(d => d.estudar).length, habitMaxValues.estudar),     
      descansar: Math.min(days.filter(d => d.descansar).length, habitMaxValues.descansar)  
    };
  
    // 3. PONTOS BASE (m√°ximo 40: 7+3+7+5+6+6+6)
    const pontosBase = Object.values(habitCounts).reduce((sum, count) => sum + count, 0);
  
    // 4. B√îNUS PESO (suas regras: 0, 3 ou 5 pontos)
    const bonusPeso = await calculatePesoBonus(pesoMedio, weekStartISO);
  
    // üîß CORRE√á√ÉO PRINCIPAL: COMPLETUDE INCLUI B√îNUS DE PESO
    const totalPontos = pontosBase + bonusPeso;
    const completude = Math.round((totalPontos / 40) * 100);
  
    const weekData = {
      weekStart: weekStartISO,                    // ‚úÖ Agora ser√° domingo correto
      weekStartFormatted: formatDateDisplay(weekStartISO), 
      weekEnd: addDays(weekStartISO, 6),         // ‚úÖ S√°bado da semana
      
      // Dados agregados
      pesoMedio: pesoMedio ? Math.round(pesoMedio * 10) / 10 : null, 
      ...habitCounts,
      
      // üîß CORRIGIDO: C√°lculos com b√¥nus inclu√≠do na completude
      pontosBase,        // 0-40 pontos (base dos h√°bitos)
      bonusPeso,         // 0-5 pontos (b√¥nus)
      totalPontos,       // pontosBase + bonusPeso
      completude,        // üîß BASEADO EM totalPontos/40 (INCLUI B√îNUS)
      
      // Metadados
      updatedAt: new Date().toISOString(),
      source: 'daily_aggregation'
    };
  
    return weekData;
  };
  
  // üÜï FUN√á√ÉO: CALCULAR B√îNUS DE PESO (SUAS REGRAS ESPEC√çFICAS)
  const calculatePesoBonus = async (currentPesoMedio, weekStartISO) => {
    try {
      if (!currentPesoMedio) {
        return 0;
      }
  
      // Buscar semana anterior (7 dias atr√°s)
      const previousWeekISO = addDays(weekStartISO, -7);
      const previousWeekDoc = await getDoc(doc(db, WEEKLY_AGGREGATES, previousWeekISO));
      
      if (!previousWeekDoc.exists()) {
        return 0;
      }
  
      const previousPesoMedio = previousWeekDoc.data().pesoMedio;
      if (!previousPesoMedio) {
        return 0;
      }
  
      // Calcular diferen√ßa (positivo = perdeu peso)
      const diferenca = previousPesoMedio - currentPesoMedio;
      
      // üéØ SUAS REGRAS DE B√îNUS:
      if (diferenca >= 0.3) {
        return 5; 
      } else if (diferenca > 0) {
        return 3; 
      } else {
        return 0; 
      }
  
    } catch (error) {
      return 0;
    }
  };
  
  // üîÑ FUN√á√ÉO PRINCIPAL: BUSCAR SEMANAS AGREGADAS (SUBSTITUI getAllWeeks)
  export const getWeeklyAggregates = async () => {
    try {
      const q = query(
        collection(db, WEEKLY_AGGREGATES),
        orderBy('weekStart', 'asc')  // Ordenar por data de in√≠cio da semana
      );
      
      const querySnapshot = await getDocs(q);
      const weeks = [];
      
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        
        // üîÑ CONVERTER PARA FORMATO COMPAT√çVEL COM DASHBOARD ATUAL
        weeks.push({
          id: doc.id,
          semana: data.weekStartFormatted,  
          completude: data.completude,      
          peso: data.pesoMedio,            
          
          // H√°bitos individuais (para gr√°ficos por h√°bito)
          meditar: data.meditar,           
          medicar: data.medicar,           
          exercitar: data.exercitar,       
          comunicar: data.comunicar,       
          alimentar: data.alimentar,       
          estudar: data.estudar,           
          descansar: data.descansar,       
          
          // Dados extras (novos, mas compat√≠veis)
          pontosBase: data.pontosBase,     
          bonusPeso: data.bonusPeso,       
          totalPontos: data.totalPontos,   
          
          // Compatibilidade com formato antigo
          dateOrder: parseInt(data.weekStart.replace(/-/g, '')), 
          obs: '',                         
          createdAt: data.updatedAt,
          updatedAt: data.updatedAt
        });
      });
      
      return weeks;
      
    } catch (error) {
      // Fallback: tentar buscar sem orderBy
      try {
        const simpleQuery = await getDocs(collection(db, WEEKLY_AGGREGATES));
        const simpleWeeks = [];
        
        simpleQuery.forEach((doc) => {
          const data = doc.data();
          simpleWeeks.push({
            id: doc.id,
            semana: data.weekStartFormatted,
            completude: data.completude,
            peso: data.pesoMedio,
            meditar: data.meditar,
            medicar: data.medicar,
            exercitar: data.exercitar,
            comunicar: data.comunicar,
            alimentar: data.alimentar,
            estudar: data.estudar,
            descansar: data.descansar
          });
        });
        
        return simpleWeeks;
        
      } catch (simpleError) {
        return [];
      }
    }
  };
  
  // üÜï FUN√á√ïES AUXILIARES PARA DADOS DI√ÅRIOS
  
  // Buscar um dia espec√≠fico
  export const getDayHabits = async (dateISO) => {
    try {
      const docRef = doc(db, DAILY_HABITS, dateISO);
      const docSnap = await getDoc(docRef);
      
      if (docSnap.exists()) {
        return {
          success: true,
          data: { id: docSnap.id, ...docSnap.data() }
        };
      } else {
        return {
          success: false,
          error: `Dia ${dateISO} n√£o encontrado`
        };
      }
    } catch (error) {
      return {
        success: false,
        error: error.message
      };
    }
  };
  
  // Deletar um dia (e recalcular semana)
  export const deleteDayHabits = async (dateISO) => {
    try {
      await deleteDoc(doc(db, DAILY_HABITS, dateISO));
      await recalculateWeek(getWeekStart(dateISO));
      
      return { success: true };
    } catch (error) {
      return {
        success: false,
        error: error.message
      };
    }
  };
  
  // üìù FUN√á√ïES DEPRECIADAS (mantidas para compatibilidade tempor√°ria)
  export const addWeek = async (weekData) => {
    return {
      success: false,
      error: 'Fun√ß√£o depreciada. Use saveDailyHabits() para salvar dias individuais.'
    };
  };
  
  export const getAllWeeks = async () => {
    return await getWeeklyAggregates();
  };